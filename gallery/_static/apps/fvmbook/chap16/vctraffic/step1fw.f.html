<!-- **** DO NOT EDIT THIS FILE *** 
         This file was generated automatically from file
              step1fw.f
         using $CLAW/clawutil/src/python/clawutil/clawcode2html.py         -->

<html>
<title> step1fw.f.html </title>


          <head>
           <link rel="icon" href="http://www.clawpack.org//_static/clawicon_new.ico" />
          </head> 
           <BODY TEXT="#000000" BGCOLOR="#FFFFFF" LINK="#0000FF" 
                 VLINK="#5500DD" ALINK="#FF0000">
           <font FACE="HELVETICA,ARIAL">
           
<!-- Created from the file /Users/rjl/clawpack_src/clawpack_master/apps/fvmbook/chap16/vctraffic/step1fw.f -->
<!-- Date: Sat Mar 23 2024 at 11:04:24 -->

<table bgcolor="#FFEE99"> <tr> <td>
&nbsp;<font size=6> step1fw.f.html </font> </td>

            <td><a href="http://www.clawpack.org/index.html"><img
            src="http://www.clawpack.org//_static/clawlogo_border.jpg"
            width=150 alt="CLAWPACK"></a>&nbsp;&nbsp; </td> </tr> <tr> <td>
&nbsp;Source file: &nbsp;&nbsp;<a href="step1fw.f">step1fw.f </a>
</td></tr><tr><td>
&nbsp;Directory:  &nbsp; /Users/rjl/clawpack_src/clawpack_master/apps/fvmbook/chap16/vctraffic 
</td></tr><tr><td>
&nbsp;Converted:  &nbsp; Sat Mar 23 2024 at 11:04:24 
&nbsp; using <a href="http://www.clawpack.org//doc/application_documentation.html#clawcode2html">clawcode2html</a>
</td></tr><tr><td>
<font color="#BB3300"> &nbsp;This documentation file will 
not reflect any later changes in the source file. </font>
</td></tr></table></font>
<p>
<pre> 
<font color="blue">c</font>
<font color="blue">c</font>
<font color="blue">c ===================================================================</font>
      subroutine step1(maxmx,meqn,mwaves,mbc,mx,q,aux,dx,dt,
     &              method,mthlim,cfl,f,fwave,s,amdq,apdq,dtdx,rp1)
<font color="blue">c ===================================================================</font>
<font color="blue">c</font>
<font color="blue">c     # Take one time step, updating q.</font>
<font color="blue">c</font>
<font color="blue">c     # MODIFIED to use fwave instead of wave.</font>
<font color="blue">c</font>
<font color="blue">c     method(1) = 1   ==>  Godunov method</font>
<font color="blue">c     method(1) = 2   ==>  Slope limiter method</font>
<font color="blue">c     mthlim(p)  controls what limiter is used in the pth family</font>
<font color="blue">c</font>
<font color="blue">c</font>
<font color="blue">c     amdq, apdq, fwave, s, and f are used locally:</font>
<font color="blue">c</font>
<font color="blue">c     amdq(1-mbc:maxmx+mbc, meqn) = left-going flux-differences</font>
<font color="blue">c     apdq(1-mbc:maxmx+mbc, meqn) = right-going flux-differences</font>
<font color="blue">c        e.g. amdq(i,m) = m'th component of A^- \Delta q from i'th Riemann</font>
<font color="blue">c                         problem (between cells i-1 and i).</font>
<font color="blue">c</font>
<font color="blue">c     fwave(1-mbc:maxmx+mbc, meqn, mwaves) = waves from solution of</font>
<font color="blue">c                                           Riemann problems,</font>
<font color="blue">c            fwave(i,m,mw) = mth component of jump in f across</font>
<font color="blue">c                           wave in family mw in Riemann problem between</font>
<font color="blue">c                           states i-1 and i.</font>
<font color="blue">c</font>
<font color="blue">c     s(1-mbc:maxmx+mbc, mwaves) = wave speeds,</font>
<font color="blue">c            s(i,mw) = speed of wave in family mw in Riemann problem between</font>
<font color="blue">c                      states i-1 and i.</font>
<font color="blue">c</font>
<font color="blue">c     f(1-mbc:maxmx+mbc, meqn) = correction fluxes for second order method</font>
<font color="blue">c            f(i,m) = mth component of flux at left edge of ith cell </font>
<font color="blue">c     --------------------------------------------------------------------</font>
<font color="blue">c</font>
      implicit double precision (a-h,o-z)
      dimension    q(meqn,1-mbc:maxmx+mbc)
      dimension  aux(*,1-mbc:maxmx+mbc)
      dimension    f(1-mbc:maxmx+mbc, meqn)
      dimension    s(1-mbc:maxmx+mbc, mwaves)
      dimension fwave(1-mbc:maxmx+mbc, meqn, mwaves)
      dimension amdq(1-mbc:maxmx+mbc, meqn)
      dimension apdq(1-mbc:maxmx+mbc, meqn)
      dimension dtdx(1-mbc:maxmx+mbc)
      dimension method(7),mthlim(mwaves)
      logical limit
<font color="blue">c</font>
<font color="blue">c     # check if any limiters are used:</font>
      limit = .false.
      do 5 mw=1,mwaves
	 if (mthlim(mw) .gt. 0) limit = .true.
   5     continue
<font color="blue">c</font>
      mcapa = method(6)
      do 10 i=1-mbc,mx+mbc
	 if (mcapa.gt.0) then
	     if (aux(mcapa,i) .le. 0.d0) then
		write(6,*) 'Error -- capa must be positive'
		stop
		endif
             dtdx(i) = dt / (dx*aux(mcapa,i))
	    else
             dtdx(i) = dt/dx
	    endif
   10	 continue
<font color="blue">c</font>
<font color="blue">c</font>
<font color="blue">c</font>
<font color="blue">c     # solve Riemann problem at each interface </font>
<font color="blue">c     -----------------------------------------</font>
<font color="blue">c</font>
      call rp1(maxmx,meqn,mwaves,mbc,mx,q,q,aux,aux,fwave,s,amdq,apdq)
<font color="blue">c</font>
<font color="blue">c     # Modify q for Godunov update:</font>
<font color="blue">c     # Note this may not correspond to a conservative flux-differencing</font>
<font color="blue">c     # for equations not in conservation form.  It is conservative if</font>
<font color="blue">c     # amdq + apdq = f(q(i)) - f(q(i-1)).</font>
<font color="blue">c</font>
      do 40 i=1,mx+1
         do 39 m=1,meqn
            q(m,i) = q(m,i) - dtdx(i)*apdq(i,m)
            q(m,i-1) = q(m,i-1) - dtdx(i-1)*amdq(i,m)
   39       continue
   40    continue

<font color="blue">c</font>
<font color="blue">c     # compute maximum wave speed:</font>
      cfl = 0.d0
      do 50 mw=1,mwaves
	 do 45 i=1,mx+1
<font color="blue">c          # if s>0 use dtdx(i) to compute CFL,</font>
<font color="blue">c          # if s<0 use dtdx(i-1) to compute CFL:</font>
	   cfl = dmax1(cfl, dtdx(i)*s(i,mw), -dtdx(i-1)*s(i,mw))
   45      continue
   50    continue
<font color="blue">c</font>
      if (method(2) .eq. 1) go to 900
<font color="blue">c</font>
<font color="blue">c     # compute correction fluxes for second order q_{xx} terms:</font>
<font color="blue">c     ----------------------------------------------------------</font>
<font color="blue">c</font>
      do 100 m = 1, meqn
            do 100 i = 1-mbc, mx+mbc
               f(i,m) = 0.d0
  100          continue
<font color="blue">c</font>
<font color="blue">c     # apply limiter to waves:</font>
      if (limit) then
         call limiter(maxmx,meqn,mwaves,mbc,mx,fwave,s,mthlim)
         endif

<font color="blue">c</font>
      do 120 i=1,mx+1
	 do 120 m=1,meqn
	    do 110 mw=1,mwaves
	       dtdxave = 0.5d0 * (dtdx(i-1) + dtdx(i))
	       f(i,m) = f(i,m) + 0.5d0 * dsign(1.d0,s(i,mw))
     &		   * (1.d0 - dabs(s(i,mw))*dtdxave) * fwave(i,m,mw)
<font color="blue">c</font>

  110          continue
  120       continue
<font color="blue">c</font>
<font color="blue">c</font>
  140 continue
<font color="blue">c</font>
<font color="blue">c     # update q by differencing correction fluxes </font>
<font color="blue">c     ============================================</font>
<font color="blue">c</font>
<font color="blue">c     # (Note:  Godunov update has already been performed above)</font>
<font color="blue">c</font>
      do 150 m=1,meqn
	 do 150 i=1,mx
	    q(m,i) = q(m,i) - dtdx(i) * (f(i+1,m) - f(i,m))
  150       continue
<font color="blue">c</font>
  900 continue
      return
      end

</pre></html>
